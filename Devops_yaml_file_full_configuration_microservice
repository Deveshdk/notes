trigger:
  branches:
    include:
      - develop

variables:
  buildConfiguration: 'Release'
  dotnetVersion: '8.0.x'
  artifactName: 'drop'
  azureServiceConnection: 'Azure-Service-Connection-Name'
  webAppNameDev: 'my-dotnet-microservice-dev'

stages:

# ==========================================
# BUILD & VALIDATION STAGE
# ==========================================
- stage: Build
  displayName: "Build & Validate"
  jobs:
    - job: BuildJob
      pool:
        vmImage: 'ubuntu-latest'

      steps:

        # Install .NET SDK
        - task: UseDotNet@2
          inputs:
            packageType: 'sdk'
            version: $(dotnetVersion)
          displayName: "Install .NET SDK"

        # Restore dependencies
        - script: dotnet restore
          displayName: "Restore NuGet Packages"

        # Dependency vulnerability check
        - script: dotnet list package --vulnerable
          displayName: "Check for Vulnerable Dependencies"

        # Build
        - script: dotnet build --configuration $(buildConfiguration) --no-restore
          displayName: "Build Solution"

        # Run Unit Tests
        - script: dotnet test --configuration $(buildConfiguration) --collect:"XPlat Code Coverage"
          displayName: "Run Unit Tests"

        # Publish code coverage
        - task: PublishCodeCoverageResults@2
          inputs:
            codeCoverageTool: 'Cobertura'
            summaryFileLocation: '$(Agent.TempDirectory)/**/coverage.cobertura.xml'

        # Publish Application
        - script: dotnet publish --configuration $(buildConfiguration) --output $(Build.ArtifactStagingDirectory)
          displayName: "Publish Application"

        # Publish Build Artifact
        - task: PublishBuildArtifacts@1
          inputs:
            PathtoPublish: '$(Build.ArtifactStagingDirectory)'
            ArtifactName: $(artifactName)
          displayName: "Publish Artifact"


# ==========================================
# DEPLOY TO DEV
# ==========================================
- stage: Deploy_Dev
  displayName: "Deploy to Dev"
  dependsOn: Build
  condition: succeeded()

  jobs:
    - deployment: DeployDev
      environment: 'dev'
      pool:
        vmImage: 'ubuntu-latest'

      strategy:
        runOnce:
          deploy:
            steps:
              - download: current
                artifact: $(artifactName)

              - task: AzureWebApp@1
                inputs:
                  azureSubscription: $(azureServiceConnection)
                  appName: $(webAppNameDev)
                  package: $(Pipeline.Workspace)/$(artifactName)
                displayName: "Deploy to Azure Web App (Dev)"
