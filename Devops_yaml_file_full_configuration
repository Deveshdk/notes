trigger:
  branches:
    include:
      - main
      - develop

pr:
  branches:
    include:
      - main
      - develop

variables:
  nodeVersion: '18.x'
  azureServiceConnection: 'Azure-Service-Connection-Name'
  webAppNameDev: 'my-webapp-dev'
  webAppNameProd: 'my-webapp-prod'
  artifactName: 'drop'

stages:

# =========================
# BUILD STAGE
# =========================
- stage: Build
  displayName: "Build Stage"
  jobs:
    - job: BuildJob
      displayName: "Install, Test & Build"
      pool:
        vmImage: 'ubuntu-latest'

      steps:
        - task: NodeTool@0
          inputs:
            versionSpec: $(nodeVersion)
          displayName: "Install Node.js"

        - script: |
            npm install
          displayName: "Install Dependencies"

        - script: |
            npm run test
          displayName: "Run Unit Tests"

        - script: |
            npm run build
          displayName: "Build Application"

        - task: PublishBuildArtifacts@1
          inputs:
            PathtoPublish: '$(Build.SourcesDirectory)'
            ArtifactName: $(artifactName)
            publishLocation: 'Container'
          displayName: "Publish Artifact"


# =========================
# DEPLOY TO DEV
# =========================
- stage: Deploy_Dev
  displayName: "Deploy to Dev"
  dependsOn: Build
  condition: succeeded()

  jobs:
    - deployment: DeployDev
      displayName: "Deploy to Dev Environment"
      environment: "dev"

      pool:
        vmImage: 'ubuntu-latest'

      strategy:
        runOnce:
          deploy:
            steps:
              - download: current
                artifact: $(artifactName)

              - task: AzureWebApp@1
                inputs:
                  azureSubscription: $(azureServiceConnection)
                  appName: $(webAppNameDev)
                  package: $(Pipeline.Workspace)/$(artifactName)
                displayName: "Deploy to Azure Web App - Dev"


# =========================
# DEPLOY TO PROD
# =========================
- stage: Deploy_Prod
  displayName: "Deploy to Production"
  dependsOn: Deploy_Dev
  condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))

  jobs:
    - deployment: DeployProd
      displayName: "Deploy to Production"
      environment: "production"   # You can configure approval in Azure DevOps UI

      pool:
        vmImage: 'ubuntu-latest'

      strategy:
        runOnce:
          deploy:
            steps:
              - download: current
                artifact: $(artifactName)

              - task: AzureWebApp@1
                inputs:
                  azureSubscription: $(azureServiceConnection)
                  appName: $(webAppNameProd)
                  package: $(Pipeline.Workspace)/$(artifactName)
                displayName: "Deploy to Azure Web App - Production"
